---
title: "Data Wizards (Group 4) Project 1 R Notebook"
author:
- Di Chen
- Mai Castellano
- Tyler Kussee
- Spencer Hutchison
output:
  html_document:
    df_print: paged
  html_notebook: default
  pdf_document: default
---

```{r echo=FALSE, message=FALSE, warning=FALSE}
## For your notes, an if statement for checking if a package is installed :)
#if(!require(somepackage)){
#    install.packages("somepackage")
#    library(somepackage)
#}

if (!require(tidycensus)) {
  install.packages("tidycensus")
}
if (!require(tidyverse)) {
  install.packages("tidyverse")
}
if (!require(dplyr)) {
  install.packages("dplyr")
}
if (!require(ggplot2)) {
  install.packages("ggplot2")
}
```


```{r echo=FALSE, message=FALSE, warning=FALSE}
library(tidycensus)
library(tidyverse)
library(dplyr)
library(ggplot2)

census_api_key("2547c95ce33b1ed0eec3aafd0fd8526a5bb9a22e")
```

# Introduction

The American Community Survey is an ongoing survey that provides vital information
on a yearly basis about our nation and it's people. The information from the survey 
generates data that helps inform how trillions of dollars in federal funds are distributed.

With the data from the American Community Survey, the Data Wizards have come up 
with the following 3 questions they would like to answer:

* Does higher education mean higher income accounting for sex and age?
* Can we predict household income based on education, occupation, and race/ethnicity?
* Is there a relationship between race/ethnicity and home ownership?

In particular, we'll be focusing on the first question to get started.

## Obtain the Data

In the case of the ACS dataset, we'll pull it via an API. We've already declared
our key earlier, so now we just need to pull our dataset with the variables and filtering 
we'd like. In this case we'll want to pull our Age (AGEP), Education Level (SCHL), 
sex (SEX), and Total Person's Income (PINCP) while filtering to the year 2022 and the State of OR.

```{r echo=FALSE, message=FALSE, results='hide'}
puma_data <- get_pums(variables = c("AGEP","SCHL","PINCP", "SEX")
                      ,state = "OR"
                      ,year = 2022)
```

## Scrub the data

Since we've already pulled the data, now we need to just clean up the data first. 
Let's begin by assigning the column names more descriptive names:

```{r, error=TRUE, collapse=TRUE, warning=FALSE}
puma_data <- puma_data %>% rename(Age = AGEP,
                                  EducationLevel = SCHL,
                                  Income = PINCP,
                                  Sex = SEX,
                                  PersonNumber = SPORDER)
head(puma_data[, 2:5])
```


We can remove the the ST, Serial Number, and housing weight columns for now, 
since we don't really need that information. I'll keep PersonNumber in for now,
but we can remove it if not needed.

```{r, error=TRUE, collapse=TRUE, warning=FALSE}
puma_data <- puma_data %>% 
  select(-ST, -SERIALNO, -WGTP, -PWGTP)
head(puma_data)
```

Now we'll clean up some of this data. in this case we'll convert "bb" in our Education
level to a 0, and then convert our Educational level to numeric values.

```{r}
puma_data <- puma_data %>%
  mutate(
    EducationLevel = case_when(
      EducationLevel == "bb" ~ "00",
      TRUE ~ EducationLevel
    ),
    EducationLevel = as.numeric(EducationLevel)
  )
class(puma_data$EducationLevel)
```

Now we want to create groupings of our data. In this case, we'll be grouping education levels
based on if they've had "No Education", "Lower Than High School", "High School", 
"HS Diploma or GED", "Associates Degree", "Bachelors Degree", "Masters Degree", or
a "Doctoral Degree".

```{r}
puma_data <- puma_data %>%
  mutate(
     EducationGroup = cut(EducationLevel, breaks = c(0, 2, 11, 16, 20, 21, 22, 24, Inf),
                         labels = c("No schooling completed", "Less than High School",
                                    "High School", "high school diploma or GED",
                                    "Associates Degree", "Bachelors Degree",
                                    "Masters Degree", "Doctorate Degree"),
                         right = FALSE)
  )
unique(puma_data$EducationGroup)
puma_data[1:50,]
```


Next I'll rearrange the columns:

```{r, error=TRUE, collapse=TRUE, warning=FALSE}
puma_data <- puma_data %>%
  select(EducationGroup, EducationLevel, Income, Age, Sex, PersonNumber)
head(puma_data)
```

Since we're interested in the income of individuals, let's remove all ages younger than 14. The legal working age of Oregon is 14 onwards.

```{r}
puma_data <- puma_data %>%
  filter(Age >= 14)
head(puma_data[puma_data$Age < 14,])
```


Now we should work on the variable codes to convert them to their actual descriptions to make the content easier to peruse. We'll start with Education Level and convert it from it's characters to the actual descriptions.

```{r, error=TRUE, collapse=TRUE, warning=FALSE}

#Since we're refactoring the Education levels to groups, commenting this original out.
puma_data <- puma_data %>%
  mutate(
    EducationLevel = case_when(
      EducationLevel == 0 ~ "(less than 3 years old)",
      EducationLevel == 1 ~ "No schooling completed",
      EducationLevel == 2 ~ "Nursery School / Preschool",
      EducationLevel == 3 ~ "Kindergarten",
      EducationLevel == 4 ~ "Grade 1",
      EducationLevel == 5 ~ "Grade 2",
      EducationLevel == 6 ~ "Grade 3",
      EducationLevel == 7 ~ "Grade 4",
      EducationLevel == 8 ~ "Grade 5",
      EducationLevel == 9 ~ "Grade 6",
      EducationLevel == 10 ~ "Grade 7",
      EducationLevel == 11 ~ "Grade 8",
      EducationLevel == 12 ~ "Grade 9",
      EducationLevel == 13 ~ "Grade 10",
      EducationLevel == 14 ~ "Grade 11",
      EducationLevel == 15 ~ "Grade 12 - no diploma",
      EducationLevel == 16 ~ "Regular high school diploma",
      EducationLevel == 17 ~ "GED or alternative credential",
      EducationLevel == 18 ~ "Some college, but less than 1 year",
      EducationLevel == 19 ~ "1 or more years of college credit, no degree",
      EducationLevel == 20 ~ "Associates Degree",
      EducationLevel == 21 ~ "Bachelors Degree",
      EducationLevel == 22 ~ "Masters Degree",
      EducationLevel == 23 ~ "Professional Degree beyond a Bachelors Degree",
      EducationLevel == 24 ~ "Doctorate Degree",
      TRUE ~ as.character(EducationLevel)
    )
)
puma_data[1:100,]
```

Now lets identify the genders in the dataset:

```{r, error=TRUE, collapse=TRUE, warning=FALSE}
puma_data <- puma_data %>%
  mutate(
    Sex = case_when(
      Sex == 1 ~ "Male",
      Sex == 2 ~ "Female",
      TRUE ~ as.character(Sex)
    )
)
head(puma_data)
```

With the data mostly cleaned up, we can now explore the data.

## Explore the data

We want to get a sense for the data that we'll be working with so first we'll find the range of ages that we have in our dataset. This shows that our mean and median age is very close together (43.1 and 43 respectively) showing a good distribution of ages; with a max age of 95. Education level has a similar mean and median (16.31, and 18 respectively), and it gives us a good way to  picture our distribution as well.  Unlike our age distribution the income mean and median are a bit off (35,364 and 21,000 respectively). This is something we may need to look into more in a graphical view. We also provide a table of the levels of education and the their counts.
```{r, error=TRUE, collapse=TRUE, warning=FALSE}
#Summarizing the ranges of numerical 
summary(puma_data$Age) #Range of Age
summary(puma_data$Income) #Range of Age
summary(puma_data$EducationNumber) #Range of Education
table(puma_data$EducationLevel) #Count of each level of education
```

Next we'll take a look into the income distribution in a graphical view. For this view we will also remove those that are below 0. This allows us to see a very long tailed view of the income distribution for our dataset. Our mean being the tallest point in the graph being around that $21,000 we saw in our exploration.

```{r, error=TRUE, collapse=TRUE, warning=FALSE}
ggplot(puma_data %>% filter(Income > 0), aes(Income)) +
  geom_histogram(binwidth = 10000) +
  scale_x_continuous(labels = function(x) paste0(x / 1000, "K")) +
  labs(title = "Income Distribution in Oregon"
       , x = "Income by $10k"
       , y = "Count of Individuals") +
  theme_minimal()
```

[Reference on Variables for now](https://usa.ipums.org/usa/resources/codebooks/DataDict1822.pdf)

## Model the data
```{r}
head(puma_data)
```

```{r}
# Does higher education mean higher income accounting for sex and age?
model_1 <- lm(Income ~ EducationLevel + Sex + Age, data = puma_data)

summary(model_1)
```
```{r}
# Does higher education mean higher income accounting for sex and age?
model_2 <- lm(Income ~ EducationLevel * Sex + Age, data = puma_data)

summary(model_2)
```
```{r}
# Does higher education mean higher income accounting for sex and age?
model_3 <- lm(Income ~ EducationLevel * Sex * Age, data = puma_data)

summary(model_3)
```


## Interpret the data
