EducationLevel = as.numeric(EducationLevel)
)
#Make sure it is numeric
class(puma_data$EducationLevel)
#Convert Occupation to numerical
puma_data <- puma_data %>%
mutate(
Occupation = case_when(
Occupation == "bbbb" ~ "0000",
Occupation == "000N" ~ "0000",
TRUE ~ Occupation
),
Occupation = as.numeric(Occupation)
)
#Make sure it is numeric
class(puma_data$Occupation)
#Convert homeownership
puma_data <- puma_data %>%
mutate(
Homeownership = case_when(
Homeownership == "b" ~ "0",
TRUE ~ Homeownership
),
Homeownership = as.numeric(Homeownership)
)
#Make sure it is numeric
class(puma_data$Homeownership)
#Convert HouseAcreage
puma_data <- puma_data %>%
mutate(
HouseAcreage = case_when(
HouseAcreage == "b" ~ "0",
TRUE ~ HouseAcreage
),
HouseAcreage = as.numeric(HouseAcreage)
)
#Make sure it is numeric
class(puma_data$HouseAcreage)
##Group education level
puma_data <- puma_data %>%
mutate(
EducationGroup = cut(EducationLevel, breaks = c(0, 16, 21, 22, Inf),
labels = c("Less than HS", "HS, GED, or Associates Degree",
"Bachelors Degree", "Masters Degree or higher"),
right = FALSE)
)
unique(puma_data$EducationGroup)
puma_data[1:50,]
#Drop age below 14
puma_data <- puma_data %>%
filter(Age >= 14)
head(puma_data[puma_data$Age < 14,])
#Drop income that are less than 1 from the data set
#Drop observation with 0 and negative income
puma_data <- puma_data %>% filter(Income >= 1)
head(puma_data)
sum(puma_data$Income<1)
#relabeling race
puma_data <- puma_data %>%
mutate(
Race = case_when(
Race == "1" ~ "White",
Race == "2" ~ "Black or African American",
Race == "3" ~ "American Indian",
Race == "4" ~ "Alaska Native",
Race == "5" ~ "Native American Not Specified",
Race == "6" ~ "Asian",
Race == "7" ~ "Native Hawaiian or Other Pacific Islander",
Race == "8" ~ "Other Race",
Race == "9" ~ "Two or More Races",
TRUE ~ as.character(Race)
)
)
puma_data$Race[1:100]
#relabeling MaritalStatus
puma_data <- puma_data %>%
mutate(
MaritalStatus = case_when(
MaritalStatus == "1" ~ "Married",
MaritalStatus == "2" ~ "Widowed",
MaritalStatus == "3" ~ "Divorced",
MaritalStatus == "4" ~ "Separated",
MaritalStatus == "5" ~ "Not Married/Under 15",
TRUE ~ as.character(MaritalStatus)
)
)
#Checking labels are assigned.
unique(puma_data$MaritalStatus)
puma_data$MaritalStatus[11200:11300]
#relabeling Acreage
puma_data <- puma_data %>%
mutate(
HouseAcreage = case_when(
HouseAcreage == 0 ~ "Not a one-family home",
HouseAcreage == 1 ~ "< 1 Acre",
HouseAcreage == 2 ~ "1 - 10 Acres",
HouseAcreage == 3 ~ "> 10 Acres",
TRUE ~ as.character(HouseAcreage)
)
)
#Checking labels are assigned.
unique(puma_data$HouseAcreage)
puma_data$HouseAcreage[1200:1300]
#relabeling tenure
puma_data <- puma_data %>%
mutate(
Homeownership = case_when(
Homeownership == 0 ~ "N/A",
Homeownership == 1 ~ "Owned with mortgage or loan",
Homeownership == 2 ~ "Owned free and clear",
Homeownership == 3 ~ "Rented",
Homeownership == 4 ~ "Occupied without payment of rent",
TRUE ~ as.character(Homeownership)
)
)
#Checking labels are assigned.
unique(puma_data$Homeownership)
puma_data$Homeownership[11200:11300]
#Identify gender
puma_data <- puma_data %>%
mutate(
Sex = case_when(
Sex == 1 ~ "Male",
Sex == 2 ~ "Female",
TRUE ~ as.character(Sex)
)
)
#Checking labels are assigned.
unique(puma_data$Sex)
head(puma_data$Sex)
#Occupation Grouping
puma_data <- puma_data %>%
mutate(
OccupationGroup = case_when(
between(as.numeric(Occupation), 0000, 0009) ~ "Less than 16 years old",
between(as.numeric(Occupation), 0010, 0440) ~ "Management",
between(as.numeric(Occupation), 0500, 0960) ~ "Business/Finance",
between(as.numeric(Occupation), 1000, 1240) ~ "CS/Math/Statistics",
between(as.numeric(Occupation), 1300, 1560) ~ "Engineering/Architecture",
between(as.numeric(Occupation), 1600, 1980) ~ "Science/Economics",
between(as.numeric(Occupation), 2000, 2060) ~ "Social/Therapy/Religious",
between(as.numeric(Occupation), 2100, 2180) ~ "Legal",
between(as.numeric(Occupation), 2200, 2555) ~ "Education/Library",
between(as.numeric(Occupation), 2600, 2920) ~ "Entertainment/Arts/Media/Sports",
between(as.numeric(Occupation), 3000, 3550) ~ "Medical",
between(as.numeric(Occupation), 3600, 3655) ~ "Health",
between(as.numeric(Occupation), 3700, 3960) ~ "Protective/Essential",
between(as.numeric(Occupation), 4000, 4160) ~ "Food",
between(as.numeric(Occupation), 4200, 4255) ~ "Sanitation/Groundskeeping",
between(as.numeric(Occupation), 4300, 4655) ~ "Personal/Lifestyle",
between(as.numeric(Occupation), 4700, 4965) ~ "Sales",
between(as.numeric(Occupation), 5000, 5940) ~ "Office/Administrative",
between(as.numeric(Occupation), 6005, 6130) ~ "Farming/Fishing/Forestry",
between(as.numeric(Occupation), 6200, 6765) ~ "Construction",
between(as.numeric(Occupation), 6800, 6950) ~ "BlueCollar",
between(as.numeric(Occupation), 7000, 7640) ~ "Repairs/Mechanics",
between(as.numeric(Occupation), 7700, 8990) ~ "Manufacturing",
between(as.numeric(Occupation), 9005, 9760) ~ "Transportation",
between(as.numeric(Occupation), 9800, 9830) ~ "Military",
TRUE ~ "Not Classified"
)
)
#Checking labels are assigned.
unique(puma_data$OccupationGroup)
head(puma_data$OccupationGroup)
puma_data_raw <- puma_data
head(puma_data_raw)
#Rearrange the columns
puma_data <- puma_data_raw %>%
select(EducationGroup, EducationLevel, OccupationGroup, Occupation, Income, Age, Sex, Race, Homeownership, PersonNumber)
head(puma_data)
#Summarizing the ranges of numerical
summary(puma_data$Age) #Range of Age
summary(puma_data$Income) #Range of Age
summary(puma_data$EducationLevel) #Range of Education
table(puma_data$EducationGroup) #Count of each level of education
table(puma_data$Race) #Count of each race
table(puma_data$Homeownership) #Count of each Homeownership
table(puma_data$OccupationGroup) #Count of each Occupationgroup
#Plot income distribution
ggplot(puma_data %>% filter(Income > 0), aes(Income)) +
geom_histogram(binwidth = 10000) +
scale_x_continuous(labels = function(x) paste0(x / 1000, "K")) +
labs(title = "Income Distribution in Oregon"
, x = "Income by $10k"
, y = "Count of Individuals") +
theme_minimal()
# Does higher education mean higher income accounting for sex and age?
model_1 <- lm(Income ~ EducationGroup + Sex + Age, data = puma_data)
model_2 <- lm(Income ~ EducationGroup + Sex * Age, data = puma_data)
#Compare model 1 and 2
anova(model_1, model_2)
#The full model provides a significantly better fit.
#Linearity and Homoscedasticity assumption
plot(fitted(model_2), residuals(model_2))
#Normality assumption
qqnorm(residuals(model_2))
qqline(residuals(model_2))
#Independence assumptions
plot(residuals(model_2))
#Fitted vs residuals plot exhibiting pattern
#Logged models
model_3 <- lm(log(Income) ~ EducationGroup + Sex + Age, data = puma_data, na.action = na.exclude)
model_4 <- lm(log(Income) ~ EducationGroup + Sex * Age, data = puma_data, na.action = na.exclude)
#Compare models 3 and 4
anova(model_3, model_4)
#Model 4 is the best from 2 models
#Linear regression assumption
plot(fitted(model_4), residuals(model_4))
#Normality assumption
qqnorm(residuals(model_4))
qqline(residuals(model_4))
#Independence assumptions
plot(residuals(model_4))
#Add observation ID
puma_data$ID <- 1:nrow(puma_data)
## Attaching the Case Influence Statistics with the Data
Data <- fortify(model_4, puma_data)
## Plot the Case Influence Statistics for each observation (subject)
par(mfrow=c(1,3))
qplot(ID,.hat, data = Data)
qplot(ID,.stdresid, data = Data)
qplot(ID,.cooksd, data = Data)
#There is evidence of outliers
#Test for influential observations
#Cut off point is 4/(n-k-2)
cutoff <- 4/((nrow(puma_data)-length(model_4$coefficients)-2))
#Calculate Cook's distance
cook.d <- cooks.distance(model_4)
#Plot to identify observation with Cook's distance higher than cutoff
plot(cook.d, pch=".", cex=2, main="Influential Obs by Cooks distance")  # plot cook's distance
abline(h = cutoff, col="red")  # add cutoff line
text(x=1:length(cook.d)+1, y=cook.d, labels=ifelse(cook.d>cutoff, names(cook.d),""), col="red")  # add labels
# Removing Outliers
# influential row numbers
influential <- as.numeric(names(cook.d)[(cook.d > cutoff)])
#Create another data frame without influential observations
puma_data_2 <- puma_data[-influential, ]
#Fit a regression without influential
model_5 <- lm(log(Income) ~ EducationGroup + Sex * Age, data = puma_data_2, na.action = na.exclude)
#Compare the summary before and after removing outliers
summary(model_4)
summary(model_5)
par(mfrow=c(2,2))
#Linear regression assumption
plot(fitted(model_5), residuals(model_5))
#Normality assumption
qqnorm(residuals(model_5))
qqline(residuals(model_5))
#Independence assumptions
plot(residuals(model_5))
#Multi-colinearlity
vif(model_5)
#Fit ridge regression
x <- model.matrix(log(Income) ~ EducationGroup + Sex * Age, puma_data_2)[, -1]
y <- log(puma_data_2$Income)
ridge_model <- glmnet(x, y, alpha = 0)
summary(ridge_model)
#perform 10 fold cross-validation to find optimal lambda value
cv_model <- cv.glmnet(x, y, alpha = 0)
#find optimal lambda value that minimizes test MSE
best_lambda <- cv_model$lambda.min
best_lambda
#produce plot of test MSE by lambda value
plot(cv_model)
#The lambda value that minimizes the test MSE turns out to be 0.04258514
#find coefficients of model with best lambda
model_6 <- glmnet(x, y, alpha = 0, lambda = best_lambda)
coef(model_6)
#produce Ridge trace plot
plot(ridge_model, xvar = "lambda")
#Calculate median income for 50 YO males
coef <- coef(model_6)
lw_HS_m  <- coef[1, ] + coef[5, ] + (50*coef[6, ]) + (50*1*coef[7, ]) #lower than HS male
GED_m    <- coef[1, ] + coef[2, ] + coef[5, ] + (50*coef[6, ]) + (50*1*coef[7, ]) #HS, GED, Associate degree male
bach_m   <- coef[1, ] + coef[3, ] + coef[5, ] + (50*coef[6, ]) + (50*1*coef[7, ]) #Bachelor's degree male
master_m <- coef[1, ] + coef[4, ] + coef[5, ] + (50*coef[6, ]) + (50*1*coef[7, ]) #master or higher male
exp(lw_HS_m)
exp(GED_m)
exp(bach_m)
exp(master_m)
#Calculate median income for 50 YO females
lw_HS_f  <- coef[1, ] + (50*coef[6, ]) #lower than HS female
GED_f    <- coef[1, ] + coef[2, ] + (50*coef[6, ]) #HS, GED, Associate degree female
bach_f   <- coef[1, ] + coef[3, ] + (50*coef[6, ]) #Bachelor's degree female
master_f <- coef[1, ] + coef[4, ] + (50*coef[6, ]) #master or higher female
exp(lw_HS_f)
exp(GED_f)
exp(bach_f)
exp(master_f)
# Can we predict household income based on education, occupation, and race/ethnicity?
head(puma_data_raw)
puma_data_q2 <- puma_data_raw |>
select(EducationGroup, Income, Race, OccupationGroup)
head(puma_data_q2)
summary(puma_data_q2)
puma_data_q2_race_income <- puma_data_q2 |>
group_by(Race, Income) |>
summarise(n = n())
ggplot(puma_data_q2_race_income, aes(x = Income)) +
geom_histogram(binwidth = 5000, fill = "skyblue", color = "black") +
facet_wrap(~Race) +
labs(title = "Distribution of Income by Race", x = "Income", y = "Frequency")
puma_data_q2_occ_income <- puma_data_q2 |>
group_by(OccupationGroup, Income) |>
summarise(n = n())
ggplot(puma_data_q2_occ_income, aes(x = Income)) +
geom_histogram(binwidth = 5000, fill = "skyblue", color = "black") +
facet_wrap(~OccupationGroup) +
labs(title = "Distribution of Income by Occupation Group and Race", x = "Income", y = "Frequency")
head(puma_data_raw)
puma_data_q3 <- puma_data_raw |>
select(Homeownership, Race, MaritalStatus, OccupationGroup, Occupation, Income)
head(puma_data_q3)
puma_data_filtered <- puma_data_q3 |>
filter(Occupation != 0)
ggplot(puma_data_filtered, aes(x = Occupation)) +
geom_bar(fill = "skyblue", color = "black") +
labs(title = "Distribution of Occupations", x = "Occupation", y = "Count") +
theme(axis.text.x = element_text(angle = 45, hjust = 1))
ggplot(puma_data_q3, aes(x = OccupationGroup, y = Occupation)) +
geom_bar(stat = "identity", fill = "skyblue", color = "black") +
labs(title = "The relationship between OccupationGroup and Occupation Size", x = "OccupationGroup", y = "Occupation Size") +
theme(axis.text.x = element_text(angle = 45, hjust = 1))
ggplot(puma_data_q3, aes(x = Homeownership, y = Occupation)) +
geom_bar(stat = "identity", fill = "skyblue", color = "black") +
labs(title = "The relationship between Homeownership and Occupation Size", x = "Homeownership", y = "Occupation Size") +
theme(axis.text.x = element_text(angle = 45, hjust = 1))
ggplot(puma_data_q3, aes(x = Race, fill = factor(Occupation))) +
geom_bar() +
labs(title = "Occupation vs. Homeownership by Race", x = "Race", y = "Count of Occupations") +
scale_fill_manual(values = c("White" = "blue", "Black" = "red")) +  # Customize colors for each race
theme(axis.text.x = element_text(angle = 45, hjust = 1))
model_1_q3 <- lm(Occupation ~ as.factor(MaritalStatus) + as.factor(OccupationGroup)
+ as.factor(Homeownership) + as.factor(Race) + Income, data = puma_data_q3)
summary(model_1_q3)
model_2_q3 <- lm(Occupation ~ as.factor(MaritalStatus) + as.factor(OccupationGroup)
+ as.factor(Homeownership) + Income, data = puma_data_q3)
summary(model_2_q3)
#Compare models 1 and model 2
anova(model_1_q3, model_2_q3)
plot(fitted(model_1_q3), residuals(model_1_q3))
qqnorm(residuals(model_1_q3))
qqline(residuals(model_1_q3))
plot(residuals(model_1_q3))
#Fitted vs residuals plot exhibiting pattern
model_3_q3 <- lm(Occupation ~ as.factor(MaritalStatus) * as.factor(OccupationGroup)
+ as.factor(Homeownership) + as.factor(Race) + Income, data = puma_data_q3)
model_4_q3 <- lm(Occupation ~ as.factor(MaritalStatus) + as.factor(OccupationGroup)
* as.factor(Homeownership) + as.factor(Race) + Income, data = puma_data_q3)
summary(model_3_q3)
summary(model_4_q3)
anova(model_3_q3, model_4_q3)
plot(fitted(model_3_q3), residuals(model_3_q3))
qqnorm(residuals(model_3_q3))
qqline(residuals(model_3_q3))
plot(residuals(model_3_q3))
#Fitted vs residuals plot exhibiting pattern
## An if statement for checking if a package is installed :)
#if(!require(somepackage)){
#    install.packages("somepackage")
#    library(somepackage)
#}
if (!require(tidycensus)) {
install.packages("tidycensus")
}
if (!require(tidyverse)) {
install.packages("tidyverse")
}
if (!require(dplyr)) {
install.packages("dplyr")
}
if (!require(ggplot2)) {
install.packages("ggplot2")
}
#Load libraries
library(tidycensus)
library(tidyverse)
library(dplyr)
library(ggplot2)
census_api_key("2547c95ce33b1ed0eec3aafd0fd8526a5bb9a22e")
### Obtain the Data
#Pull data set for specific variables
puma_data <- get_pums(variables = c("AGEP","SCHL","PINCP", "SEX", "RAC1P", "TEN")
,state = "OR"
,year = 2022)
#Rename the columns
puma_data <- puma_data %>% rename(Age = AGEP,
EducationLevel = SCHL,
Income = PINCP,
Sex = SEX,
PersonNumber = SPORDER)
head(puma_data[, 2:5])
#Remove columns that are not needed
puma_data <- puma_data %>%
select(-ST, -SERIALNO, -WGTP, -PWGTP)
head(puma_data)
#Convert education levels
puma_data <- puma_data %>%
mutate(
EducationLevel = case_when(
EducationLevel == "bb" ~ "00",
TRUE ~ EducationLevel
),
EducationLevel = as.numeric(EducationLevel)
)
#Make sure it is numeric
class(puma_data$EducationLevel)
##Group education level
puma_data <- puma_data %>%
mutate(
EducationGroup = cut(EducationLevel, breaks = c(0, 2, 11, 16, 20, 21, 22, 24, Inf),
labels = c("No schooling completed", "Less than High School",
"High School", "high school diploma or GED",
"Associates Degree", "Bachelors Degree",
"Masters Degree", "Doctorate Degree"),
right = FALSE)
)
unique(puma_data$EducationGroup)
puma_data[1:50,]
#Rearrange the columns
puma_data <- puma_data %>%
select(EducationGroup, EducationLevel, Income, Age, Sex, PersonNumber)
head(puma_data)
#Drop age below 14
puma_data <- puma_data %>%
filter(Age >= 14)
head(puma_data[puma_data$Age < 14,])
#Identify gender
puma_data <- puma_data %>%
mutate(
Sex = case_when(
Sex == 1 ~ "Male",
Sex == 2 ~ "Female",
TRUE ~ as.character(Sex)
)
)
head(puma_data)
### Explore the data
#Summarizing the ranges of numerical
summary(puma_data$Age) #Range of Age
summary(puma_data$Income) #Range of Age
summary(puma_data$EducationNumber) #Range of Education
table(puma_data$EducationLevel) #Count of each level of education
#Plot inceom distribution
ggplot(puma_data %>% filter(Income > 0), aes(Income)) +
geom_histogram(binwidth = 10000) +
scale_x_continuous(labels = function(x) paste0(x / 1000, "K")) +
labs(title = "Income Distribution in Oregon"
, x = "Income by $10k"
, y = "Count of Individuals") +
theme_minimal()
##[Reference on Variables for now](https://usa.ipums.org/usa/resources/codebooks/DataDict1822.pdf)
### Model the data
#Drop zero income from the data set
#Drop observation with 0 income (unemployed individuals)
puma_data <- puma_data[puma_data$Income != 0, ]
puma_data
head(puma_data)
# Does higher education mean higher income accounting for sex and age?
model_1 <- lm(Income ~ EducationGroup + Sex + Age, data = puma_data)
model_2 <- lm(Income ~ EducationGroup + Sex * Age, data = puma_data)
model_3 <- lm(Income ~ EducationGroup * Sex + Age, data = puma_data)
model_4 <- lm(Income ~ EducationGroup * Sex * Age, data = puma_data)
#Compare model 3 and 4
anova(model_3, model_4)
#The full model provides a significantly better fit.
#Compare model 2 and 4
anova(model_2, model_4)
#Model 4 is a better fit.
#Compare model 1 and 4
anova(model_1, model_4)
##Check the assumption
#Linearity and Homoscedasticity assumption
plot(fitted(model_4), residuals(model_4))
#Normality assumption
qqnorm(residuals(model_4))
qqline(residuals(model_4))
#Independence assumptions
plot(residuals(model_4))
#Fitted vs residuals plot exhibiting pattern
#Consider log transformation of the response variable:
#Logged models
model_5 <- lm(log(Income) ~ EducationGroup + Sex + Age, data = puma_data, na.action = na.exclude)
model_6 <- lm(log(Income) ~ EducationGroup + Sex * Age, data = puma_data, na.action = na.exclude)
model_7 <- lm(log(Income) ~ EducationGroup * Sex + Age, data = puma_data, na.action = na.exclude)
model_8 <- lm(log(Income) ~ EducationGroup * Sex * Age, data = puma_data, na.action = na.exclude)
#Compare models 7 and 8
anova(model_7, model_8)
#Compare models 6 and 8
anova(model_6, model_8)
#Compare models 5 and 8
anova(model_5, model_8)
#Model 8 is the best from 4 models
#Check the assumption
#Linear regression assumption
plot(fitted(model_8), residuals(model_8))
#Normality assumption
qqnorm(residuals(model_8))
qqline(residuals(model_8))
#Use predict() to fit the regression and find the average income for 50 YO males
new_data_1 <- data.frame(EducationGroup = c("No schooling completed","Less than High School", "High School", "high school diploma or GED","Associates Degree", "Bachelors Degree", "Masters Degree", "Doctorate Degree"),
Sex = "Male",
Age = 50)
mu_1 <- predict(model_8, newdata = new_data_1 , type = "response")
exp(mu_1)
#Use predict() to fit the regression and find the average income for 50 YO femails
new_data_2 <- data.frame(EducationGroup = c("No schooling completed","Less than High School", "High School", "high school diploma or GED","Associates Degree", "Bachelors Degree", "Masters Degree", "Doctorate Degree"),
Sex = "Female",
Age = 50)
mu_2 <- predict(model_8, newdata = new_data_2 , type = "response")
exp(mu_2)
